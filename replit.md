# Overview

A comprehensive school bus tracking and management system built with React (frontend) and Express (backend). The application provides real-time GPS tracking, attendance management, and role-based dashboards for parents, drivers, and administrators. It features comprehensive fleet management capabilities, admin-driver coordination system, and role-based authentication. The system uses shadcn/ui components and integrates with PostgreSQL via Drizzle ORM for data persistence. The project's ambition is to provide a multi-tenant solution for various school districts.

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## Frontend Architecture

The client uses a React SPA with TypeScript, built with Vite. The UI is constructed using shadcn/ui components built on Radix UI primitives with Tailwind CSS for styling.

**Key architectural decisions:**
- **Component Structure**: Organized into role-specific components (admin/, driver/, parent/) and shared components (shared/, ui/)
- **Routing**: Uses Wouter for client-side routing with role-based dashboard routing
- **State Management**: TanStack Query for server state management and caching
- **Form Handling**: React Hook Form with Zod validation for type-safe form management
- **Styling**: Tailwind CSS with CSS custom properties for theming support

## Backend Architecture

The server implements a REST API using Express.js with TypeScript. It follows a layered architecture with clear separation of concerns.

**Key architectural decisions:**
- **API Layer**: Express routes with middleware for authentication and logging
- **Data Access**: Storage interface pattern with Drizzle ORM for database operations
- **Authentication**: Custom email/password authentication using bcryptjs for secure password hashing and session-based authentication with PostgreSQL-backed session store.
- **Error Handling**: Centralized error handling middleware with proper HTTP status codes

## Database Design

Uses PostgreSQL with Drizzle ORM for type-safe database operations. The schema supports multi-tenant operations with role-based access control.

**Core entities:**
- **Companies**: Core multi-tenant table for data isolation.
- **Users**: Role-based user system (parent, driver, admin) with profile management, linked to companies.
- **Students**: Student records linked to parents, schools, routes, and companies.
- **Routes & Stops**: Route planning with sequential stops and timing information, linked to companies.
- **Buses**: Vehicle management with status tracking and maintenance records, linked to companies.
- **Attendance**: Real-time attendance tracking with pickup/dropoff timestamps, linked to companies.
- **Notifications**: In-app notification system for parents, linked to companies.
- **LinkCodes**: Unique codes (e.g., TNT-483921) generated by admins for parent-child linking, with configurable max uses and expiration.
- **ParentChildLinks**: Many-to-many relationship between parents and students, supporting multiple parents per child.

## Parent-Child Linking System

Admins generate unique linking codes for students, which parents use to connect to their children's accounts.

**Features:**
- **Code Generation**: Admins generate codes via LinkCodeManager component with configurable max uses (default: 2) and expiration (default: 7 days)
- **Code Format**: Three-letter prefix followed by 6 digits (e.g., TNT-483921)
- **Access Control**: Parents only see linked children at the database query level, not just UI
- **Multi-Parent Support**: Multiple parents can link to the same child using the same or different codes
- **Admin Management**: View linked parents, revoke codes, regenerate codes, unlink parents

## Authentication & Authorization

Implements a custom email/password authentication system.

**Security features:**
- **Session Management**: PostgreSQL-backed sessions with configurable TTL.
- **Role-Based Access**: Route-level authorization based on user roles (parent, driver, admin, master_admin).
- **CSRF Protection**: Session-based authentication with secure cookies.
- **API Security**: Middleware-based authentication checks on protected routes.

## Multi-Tenant SaaS Platform

The application supports a complete multi-tenant SaaS model with business onboarding and billing.

**Master Admin Role:**
- Platform owner role with `master_admin` type and null companyId
- Access to `/api/master-admin/*` routes for company management
- Master admin dashboard at root route for master_admin users
- Approve, reject, or suspend business tenants

**Business Onboarding Flow:**
1. Business signup at `/business/signup` - creates company with `pending_approval` status
2. Plan selection at `/onboarding/plans` - fetches active Stripe prices
3. Stripe checkout integration for payment processing
4. Success/pending pages for post-payment status display
5. Master admin approval required before full access

**Stripe Integration:**
- Stripe client via Replit connector (`server/stripeClient.ts`)
- Webhook handlers for checkout.session.completed, subscription updates, invoice events
- stripe-replit-sync for managed webhooks and data synchronization
- Billing status enum: none, trialing, active, past_due, canceled, unpaid
- Seed script at `scripts/seed-stripe-products.ts` for creating subscription plans

## Subscription Plans & User Limits

The platform offers three subscription tiers with different user limits and features:

**Starter Plan ($49/month):**
- Staff users (Admin + Driver): max 3
- Parent users: NOT allowed (0)
- Features: Core admin/driver functionality only
- No parent portal, no GPS, no link codes

**Professional Plan ($99/month):**
- Staff users (Admin + Driver): max 5
- Parent users: UNLIMITED
- Features: Full platform including parent portal, GPS, messaging, link codes

**Enterprise Plan ($249/month):**
- Staff users: UNLIMITED
- Parent users: UNLIMITED
- Features: All Professional features + priority support

**Enforcement Logic:**
- `storage.canCreateUser(companyId, role)` checks plan limits before user creation
- `getStaffUserCount` and `getParentUserCount` count users by role type
- Parent portal routes check `parentPortalEnabled` and require companyId
- Link code generation blocked on Starter plan
- Stripe webhook handlers automatically set plan config when subscription changes

**Company Status Lifecycle:**
- `pending_approval` - New signups awaiting master admin review
- `approved` - Active companies with platform access
- `suspended` - Temporarily disabled by master admin
- `rejected` - Denied applications
- `cancelled` - Self-cancelled subscriptions

## Driver Onboarding System

Admins create driver accounts, and drivers receive email invitations to set up their passwords.

**Flow:**
1. Admin creates a driver in the admin dashboard with email address
2. System automatically sends password setup email to the driver
3. Driver clicks link in email and is directed to `/driver/password-setup?token=xxx`
4. Driver sets their password via the secure setup form
5. Driver can now log in with email and password

**Security Features:**
- **Token Hashing**: Invitation tokens are hashed with SHA-256 before storage (tokenHash column)
- **24-Hour Expiry**: Tokens expire after 24 hours for security
- **Single-Use**: Each invitation can only be used once; previous invitations are invalidated when new ones are created
- **Company Scoping**: Invitations are tied to companies for multi-tenant isolation

**Admin Controls:**
- Resend invitation button in driver management table (blue envelope icon)
- Automatic invitation sending when drivers are created with email addresses
- Check invitation status via `/api/drivers/:id/invitation-status` endpoint

**Database Table**: `driverInvitations` stores tokenHash, expiresAt, acceptedAt, driverId, email, companyId, and status (pending/accepted/expired)

## Route Stop Completion Tracking

Drivers can mark stops as "arrived" to notify parents and show stop progress.

**Driver Features:**
- "Mark Arrived" button on each route stop in the driver dashboard
- Completed stops show green checkmarks and "Arrived" badges
- Stop completion data resets daily

**Parent Features:**
- Live tracking card shows "Bus is X stops away" or "Bus arrived at your stop!"
- Automatic notifications when the bus arrives at their child's stop
- Progress banners update every 10 seconds

**Database Table**: `routeStopCompletions` stores routeStopId, routeId, driverId, busId, companyId, stopSequence, completionDate, and arrivedAt

**API Endpoints:**
- `POST /api/driver/mark-stop-completed` - Driver marks a stop as arrived
- `GET /api/routes/:routeId/completed-stops` - Get today's completed stops
- `GET /api/parent/stop-progress/:studentId` - Get stop progress for a student
- `POST /api/driver/reset-route-stops` - Reset stops for a new route run

# External Dependencies

- **Database**: PostgreSQL via Neon serverless for scalable data storage.
- **UI Framework**: Radix UI primitives for accessible component foundation.
- **HTTP Client**: Native fetch API for client-server communication.
- **Build Tools**: Vite for development and production builds with ESBuild.
- **ORM**: Drizzle for type-safe database operations and migrations.
- **Authentication**: bcryptjs for password hashing.